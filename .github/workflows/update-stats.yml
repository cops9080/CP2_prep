# .github/workflows/update-stats.yml (ê°„ë‹¨í•œ ë²„ì „)
name: Update Learning Stats

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Update Statistics with Shell
      run: |
        echo "ğŸ“Š í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘..."
        
        # Java íŒŒì¼ ìˆ˜ ê³„ì‚°
        JAVA_FILES=$(find . -name "*.java" -not -path "./.git/*" | wc -l)
        
        # í´ë˜ìŠ¤ ìˆ˜ ê³„ì‚°
        CLASS_COUNT=$(grep -r "^public class\|^class\|^abstract class" --include="*.java" . 2>/dev/null | wc -l)
        
        # í”„ë¡œì íŠ¸ ìˆ˜ ê³„ì‚°
        PROJECT_COUNT=$(find . -name "Main.java" -o -name "*App.java" | wc -l)
        
        # ì´ ì»¤ë°‹ ìˆ˜
        TOTAL_COMMITS=$(git rev-list --all --count)
        
        # ìµœê·¼ 7ì¼ ì»¤ë°‹ ìˆ˜
        RECENT_COMMITS=$(git log --since="7 days ago" --oneline | wc -l)
        
        # í•™ìŠµ ì¼ìˆ˜ ê³„ì‚°
        if [ -n "$(git log --reverse --format="%ct" | head -n1)" ]; then
            FIRST_COMMIT=$(git log --reverse --format="%ct" | head -n1)
            TODAY=$(date +%s)
            LEARNING_DAYS=$(( (TODAY - FIRST_COMMIT) / 86400 + 1 ))
        else
            LEARNING_DAYS=1
        fi
        
        # í˜„ì¬ ë‚ ì§œ
        CURRENT_DATE=$(date '+%Y.%m.%d %H:%M')
        
        echo "ìˆ˜ì§‘ëœ í†µê³„:"
        echo "- í•™ìŠµ ì¼ìˆ˜: $LEARNING_DAYSì¼"
        echo "- Java íŒŒì¼: $JAVA_FILESê°œ"
        echo "- í´ë˜ìŠ¤: $CLASS_COUNTê°œ"
        echo "- í”„ë¡œì íŠ¸: $PROJECT_COUNTê°œ"
        echo "- ì´ ì»¤ë°‹: $TOTAL_COMMITSê°œ"
        echo "- ìµœê·¼ ì»¤ë°‹: $RECENT_COMMITSê°œ"
        
        # README.md ë°±ì—…
        cp README.md README.md.backup
        
        # ìƒˆë¡œìš´ í†µê³„ ì„¹ì…˜ ìƒì„±
        cat > temp_stats.md << EOF
## ğŸ“Š í•™ìŠµ í†µê³„
- **ì´ í•™ìŠµ ì¼ìˆ˜**: ${LEARNING_DAYS}ì¼
- **Java íŒŒì¼ ìˆ˜**: ${JAVA_FILES}ê°œ
- **ì‘ì„±í•œ í´ë˜ìŠ¤**: ${CLASS_COUNT}ê°œ
- **ì™„ì„±í•œ í”„ë¡œì íŠ¸**: ${PROJECT_COUNT}ê°œ
- **ì´ ì»¤ë°‹ ìˆ˜**: ${TOTAL_COMMITS}ê°œ
- **ìµœê·¼ 7ì¼ ì»¤ë°‹**: ${RECENT_COMMITS}ê°œ

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: $CURRENT_DATE

> ğŸ“ˆ ì´ í†µê³„ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ (GitHub Actions)
EOF
        
        # README.md ì—…ë°ì´íŠ¸
        if grep -q "## ğŸ“Š í•™ìŠµ í†µê³„" README.md; then
            # ê¸°ì¡´ í†µê³„ ì„¹ì…˜ì„ ìƒˆ í†µê³„ë¡œ êµì²´
            awk '
                /^## ğŸ“Š í•™ìŠµ í†µê³„/ { 
                    while ((getline line < "temp_stats.md") > 0) print line
                    close("temp_stats.md")
                    while (getline && !/^##/) continue
                    if (/^##/) print
                    next
                }
                { print }
            ' README.md > README_new.md
            mv README_new.md README.md
        else
            # í†µê³„ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ë§¨ ëì— ì¶”ê°€
            echo "" >> README.md
            cat temp_stats.md >> README.md
        fi
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm temp_stats.md README.md.backup
        
        echo "âœ… í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ“Š í•™ìŠµ í†µê³„ ìë™ ì—…ë°ì´íŠ¸"
        git push
