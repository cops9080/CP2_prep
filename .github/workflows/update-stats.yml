# .github/workflows/update-stats.yml
name: Update Learning Stats

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì •ì— ì‹¤í–‰

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        
    - name: Update Statistics
      run: |
        echo "ğŸ“Š í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘..."
        
        # Java íŒŒì¼ ìˆ˜ ê³„ì‚°
        JAVA_FILES=$(find . -name "*.java" -not -path "./.git/*" | wc -l)
        
        # í´ë˜ìŠ¤ ìˆ˜ ê³„ì‚°
        CLASS_COUNT=$(grep -r "^public class\|^class\|^abstract class" --include="*.java" . 2>/dev/null | wc -l)
        
        # í”„ë¡œì íŠ¸ ìˆ˜ ê³„ì‚° (Main.java, *App.java íŒŒì¼ì´ ìˆëŠ” ê²½ìš°)
        PROJECT_COUNT=$(find . -name "Main.java" -o -name "*App.java" 2>/dev/null | wc -l)
        
        # ì´ ì»¤ë°‹ ìˆ˜
        TOTAL_COMMITS=$(git rev-list --all --count 2>/dev/null || echo "0")
        
        # ìµœê·¼ 7ì¼ ì»¤ë°‹ ìˆ˜
        RECENT_COMMITS=$(git log --since="7 days ago" --oneline 2>/dev/null | wc -l)
        
        # í•™ìŠµ ì¼ìˆ˜ ê³„ì‚°
        if FIRST_COMMIT=$(git log --reverse --format="%ct" 2>/dev/null | head -n1) && [ -n "$FIRST_COMMIT" ]; then
            TODAY=$(date +%s)
            LEARNING_DAYS=$(( (TODAY - FIRST_COMMIT) / 86400 + 1 ))
        else
            LEARNING_DAYS=1
        fi
        
        # í˜„ì¬ ë‚ ì§œ
        CURRENT_DATE=$(date '+%Y.%m.%d %H:%M')
        
        echo "ìˆ˜ì§‘ëœ í†µê³„:"
        echo "- í•™ìŠµ ì¼ìˆ˜: $LEARNING_DAYSì¼"
        echo "- Java íŒŒì¼: $JAVA_FILESê°œ"  
        echo "- í´ë˜ìŠ¤: $CLASS_COUNTê°œ"
        echo "- í”„ë¡œì íŠ¸: $PROJECT_COUNTê°œ"
        echo "- ì´ ì»¤ë°‹: $TOTAL_COMMITSê°œ"
        echo "- ìµœê·¼ ì»¤ë°‹: $RECENT_COMMITSê°œ"
        
        # README.md ë°±ì—…
        cp README.md README.md.backup
        
        # ìƒˆë¡œìš´ í†µê³„ ì„¹ì…˜ ìƒì„±
        cat > temp_stats.md << 'EOF'
## ğŸ“Š í•™ìŠµ í†µê³„
- **ì´ í•™ìŠµ ì¼ìˆ˜**: LEARNING_DAYS_PLACEHOLDERì¼
- **Java íŒŒì¼ ìˆ˜**: JAVA_FILES_PLACEHOLDERê°œ
- **ì‘ì„±í•œ í´ë˜ìŠ¤**: CLASS_COUNT_PLACEHOLDERê°œ
- **ì™„ì„±í•œ í”„ë¡œì íŠ¸**: PROJECT_COUNT_PLACEHOLDERê°œ
- **ì´ ì»¤ë°‹ ìˆ˜**: TOTAL_COMMITS_PLACEHOLDERê°œ
- **ìµœê·¼ 7ì¼ ì»¤ë°‹**: RECENT_COMMITS_PLACEHOLDERê°œ

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: CURRENT_DATE_PLACEHOLDER

> ğŸ“ˆ ì´ í†µê³„ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ (GitHub Actions)
EOF
        
        # í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´
        sed -i "s/LEARNING_DAYS_PLACEHOLDER/$LEARNING_DAYS/g" temp_stats.md
        sed -i "s/JAVA_FILES_PLACEHOLDER/$JAVA_FILES/g" temp_stats.md  
        sed -i "s/CLASS_COUNT_PLACEHOLDER/$CLASS_COUNT/g" temp_stats.md
        sed -i "s/PROJECT_COUNT_PLACEHOLDER/$PROJECT_COUNT/g" temp_stats.md
        sed -i "s/TOTAL_COMMITS_PLACEHOLDER/$TOTAL_COMMITS/g" temp_stats.md
        sed -i "s/RECENT_COMMITS_PLACEHOLDER/$RECENT_COMMITS/g" temp_stats.md
        sed -i "s/CURRENT_DATE_PLACEHOLDER/$CURRENT_DATE/g" temp_stats.md
        
        # README.mdì—ì„œ ê¸°ì¡´ í†µê³„ ì„¹ì…˜ êµì²´
        if grep -q "## ğŸ“Š í•™ìŠµ í†µê³„" README.md; then
            echo "ê¸°ì¡´ í†µê³„ ì„¹ì…˜ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
            # í†µê³„ ì„¹ì…˜ ì‹œì‘ë¶€í„° ë‹¤ìŒ ## ì„¹ì…˜ ë˜ëŠ” íŒŒì¼ ëê¹Œì§€ êµì²´
            awk '
                /^## ğŸ“Š í•™ìŠµ í†µê³„/ { 
                    while ((getline line < "temp_stats.md") > 0) print line
                    close("temp_stats.md")
                    # ë‹¤ìŒ ## ì„¹ì…˜ê¹Œì§€ ê±´ë„ˆë›°ê¸°
                    while (getline && !/^## /) continue
                    if (/^## /) print
                    next
                }
                { print }
            ' README.md > README_new.md
            mv README_new.md README.md
        else
            echo "ìƒˆë¡œìš´ í†µê³„ ì„¹ì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤..."
            echo "" >> README.md
            cat temp_stats.md >> README.md
        fi
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm temp_stats.md
        
        echo "âœ… README.md í†µê³„ ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ğŸ“Š í•™ìŠµ í†µê³„ ìë™ ì—…ë°ì´íŠ¸"
          git push
          echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì»¤ë°‹ë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"
        fi
