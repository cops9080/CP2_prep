# .github/workflows/update-stats.yml
name: Update Learning Stats

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Update Statistics
      run: |
        echo "ğŸ“Š í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘..."
        
        # Java íŒŒì¼ ìˆ˜ ê³„ì‚°
        JAVA_FILES=$(find . -name "*.java" -not -path "./.git/*" | wc -l)
        
        # í´ë˜ìŠ¤ ìˆ˜ ê³„ì‚°
        CLASS_COUNT=$(grep -r "^public class\|^class\|^abstract class" --include="*.java" . 2>/dev/null | wc -l)
        
        # í”„ë¡œì íŠ¸ ìˆ˜ ê³„ì‚°
        PROJECT_COUNT=$(find . -name "Main.java" -o -name "*App.java" 2>/dev/null | wc -l)
        
        # ì´ ì»¤ë°‹ ìˆ˜
        TOTAL_COMMITS=$(git rev-list --all --count 2>/dev/null || echo "0")
        
        # ìµœê·¼ 7ì¼ ì»¤ë°‹ ìˆ˜
        RECENT_COMMITS=$(git log --since="7 days ago" --oneline 2>/dev/null | wc -l)
        
        # í•™ìŠµ ì¼ìˆ˜ ê³„ì‚°
        if FIRST_COMMIT=$(git log --reverse --format="%ct" 2>/dev/null | head -n1) && [ -n "$FIRST_COMMIT" ]; then
            TODAY=$(date +%s)
            LEARNING_DAYS=$(( (TODAY - FIRST_COMMIT) / 86400 + 1 ))
        else
            LEARNING_DAYS=1
        fi
        
        # í˜„ì¬ ë‚ ì§œ
        CURRENT_DATE=$(date '+%Y.%m.%d %H:%M')
        
        echo "ìˆ˜ì§‘ëœ í†µê³„:"
        echo "- í•™ìŠµ ì¼ìˆ˜: $LEARNING_DAYSì¼"
        echo "- Java íŒŒì¼: $JAVA_FILESê°œ"
        echo "- í´ë˜ìŠ¤: $CLASS_COUNTê°œ"
        echo "- í”„ë¡œì íŠ¸: $PROJECT_COUNTê°œ"
        echo "- ì´ ì»¤ë°‹: $TOTAL_COMMITSê°œ"
        echo "- ìµœê·¼ ì»¤ë°‹: $RECENT_COMMITSê°œ"
        
        # ìƒˆë¡œìš´ í†µê³„ ì„¹ì…˜ ìƒì„±
        STATS_CONTENT="## ğŸ“Š í•™ìŠµ í†µê³„
        - **ì´ í•™ìŠµ ì¼ìˆ˜**: ${LEARNING_DAYS}ì¼
        - **Java íŒŒì¼ ìˆ˜**: ${JAVA_FILES}ê°œ
        - **ì‘ì„±í•œ í´ë˜ìŠ¤**: ${CLASS_COUNT}ê°œ
        - **ì™„ì„±í•œ í”„ë¡œì íŠ¸**: ${PROJECT_COUNT}ê°œ
        - **ì´ ì»¤ë°‹ ìˆ˜**: ${TOTAL_COMMITS}ê°œ
        - **ìµœê·¼ 7ì¼ ì»¤ë°‹**: ${RECENT_COMMITS}ê°œ

        **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: $CURRENT_DATE

        > ğŸ“ˆ ì´ í†µê³„ëŠ” ë§¤ì¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ (GitHub Actions)"
        
        # README.md ì²˜ë¦¬
        if grep -q "## ğŸ“Š í•™ìŠµ í†µê³„" README.md; then
            echo "ê¸°ì¡´ í†µê³„ ì„¹ì…˜ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
            
            # í†µê³„ ì„¹ì…˜ ì´ì „ ë¶€ë¶„ ì €ì¥
            sed '/## ğŸ“Š í•™ìŠµ í†µê³„/,$d' README.md > temp_before.md
            
            # í†µê³„ ì„¹ì…˜ ì´í›„ ë¶€ë¶„ ì°¾ê¸° (ë‹¤ìŒ ## ì„¹ì…˜ë¶€í„°)
            sed -n '/## ğŸ“Š í•™ìŠµ í†µê³„/,$ p' README.md | sed -n '/## [^ğŸ“Š]/,$ p' > temp_after.md
            
            # ìƒˆë¡œìš´ README.md ìƒì„±
            cat temp_before.md > README.md
            echo "$STATS_CONTENT" >> README.md
            
            # ì´í›„ ì„¹ì…˜ì´ ìˆìœ¼ë©´ ì¶”ê°€
            if [ -s temp_after.md ]; then
                echo "" >> README.md
                cat temp_after.md >> README.md
            fi
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -f temp_before.md temp_after.md
        else
            echo "ìƒˆë¡œìš´ í†µê³„ ì„¹ì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤..."
            echo "" >> README.md
            echo "$STATS_CONTENT" >> README.md
        fi
        
        echo "âœ… README.md í†µê³„ ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        if git diff --staged --quiet; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ğŸ“Š í•™ìŠµ í†µê³„ ìë™ ì—…ë°ì´íŠ¸"
          git push
          echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì»¤ë°‹ë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"
        fi
